---
title: "ファイルを移動する"
linkTitle: "ファイルを移動する"
tags:
  - Golang
---

{{% pageinfo %}}
ドキュメントは作成中です。
{{% /pageinfo %}}

まず Rename を試みます。移動元、移動先が同一ファイルシステム内であれば Rename だけで OK です。
Rename できない場合は、移動元がディレクトリであればディレクトリ内のエントリについて Move 関数を再帰的に実行します。
移動元がファイルであれば該当ファイルを開いて移動先へ書き込み、完了したら移動元のファイルを削除します。
シンボリックリンクなど考慮していないため、これだけでは不十分であることに注意してください。

```go
func Move(oldpath, newpath string) error {
	if err := os.Rename(oldpath, newpath); err == nil {
		return nil
	}

	src, err := os.OpenFile(oldpath, os.O_RDONLY, 0)
	if err != nil {
		return err
	}

	fi, err := src.Stat()
	if err != nil {
		src.Close()
		return err
	}

	if fi.IsDir() {
		if err := os.Mkdir(newpath, fi.Mode().Perm()); err != nil {
			src.Close()
			return err
		}

		fl, err := src.Readdir(-1)
		src.Close()
		if err != nil {
			return err
		}

		for _, fi := range fl {
			if err := Move(filepath.Join(oldpath, fi.Name()), filepath.Join(newpath, fi.Name())); err != nil {
				return err
			}
		}

		return os.Remove(oldpath)
	}

	dst, err := os.OpenFile(newpath, os.O_RDWR|os.O_CREATE|os.O_TRUNC, fi.Mode().Perm())
	if err != nil {
		src.Close()
		return err
	}

	_, err = io.Copy(dst, src)
	src.Close()
	if err != nil {
		return err
	}

	if err := dst.Close(); err != nil {
		return err
	}

	return os.Remove(oldpath)
}
```
